<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Titan Designer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #000;
            margin: 0;
            overflow: hidden;
            height: 100vh;
        }

        /* Styles for the splash screen */
        #splash-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            color: #fff;
            z-index: 1000;
            opacity: 0;
            animation: fadeIn 1s ease-in forwards,
                       hold 1s 1s forwards,
                       fadeOut 1s 2s ease-out forwards;
        }

        #splash-screen .logo-text {
            font-size: 48px;
            font-weight: bold;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            text-align: center;
            display: flex;
            align-items: center;
        }

        #splash-screen .logo-text svg {
            margin-right: 15px;
            width: 32px;
            height: 32px;
            fill: white;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            to { opacity: 0; visibility: hidden; }
        }
        
        /* The main page content is hidden until the splash screen is done */
        #main-content-area {
            opacity: 0;
            visibility: hidden;
            transition: opacity 1s ease-in;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: absolute; /* Added */
            top: 0; /* Added */
            left: 0; /* Added */
            width: 100%; /* Added */
        }
        
        #main-content-area.visible {
            opacity: 1;
            visibility: visible;
        }

        .slide-out {
            transform: translateX(-100%);
            transition: transform 0.5s ease-in-out;
        }

        #code-editor-container {
            position: absolute;
            top: 0;
            left: 100%;
            width: 100%;
            height: 100%;
            transition: left 0.5s ease-in-out;
        }

        #code-editor-container.slide-in {
            left: 0;
        }

    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="logo-text">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-13c-.83 0-1.5-.67-1.5-1.5S11.17 5 12 5s1.5.67 1.5 1.5S12.83 7 12 7zm0 10c-.83 0-1.5-.67-1.5-1.5S11.17 14 12 14s1.5.67 1.5 1.5S12.83 17 12 17zm0-5c-2.76 0-5 2.24-5 5h3c0-1.1.9-2 2-2s2 .9 2 2h3c0-2.76-2.24-5-5-5zM9 13c-.55 0-1 .45-1 1s.45 1 1 1h.5v-2H9zm6 0v2h.5c.55 0 1-.45 1-1s-.45-1-1-1H15zM7 9v1h2V9H7zm8 0v1h2V9h-2z"/>
            </svg>
            Titan Developer
        </div>
    </div>

    <div id="main-content-area">
        <header>
            <div class="logo">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-13c-.83 0-1.5-.67-1.5-1.5S11.17 5 12 5s1.5.67 1.5 1.5S12.83 7 12 7zm0 10c-.83 0-1.5-.67-1.5-1.5S11.17 14 12 14s1.5.67 1.5 1.5S12.83 17 12 17zm0-5c-2.76 0-5 2.24-5 5h3c0-1.1.9-2 2-2s2 .9 2 2h3c0-2.76-2.24-5-5-5zM9 13c-.55 0-1 .45-1 1s.45 1 1 1h.5v-2H9zm6 0v2h.5c.55 0 1-.45 1-1s-.45-1-1-1H15zM7 9v1h2V9H7zm8 0v1h2V9h-2z"/>
                </svg>
                Titan Designer
            </div>
        </header>
        <div class="main-content-scroll">
            <div class="alert-banner">
                <p>A powerful mobile web app designer</p>
                <p>â€¢ Native Development in your hands</p>
            </div>
            <div class="page-content-wrapper">
                <div id="action-button-wrapper"></div>
                <main class="hero-section">
                    <div class="hero-content">
                        <h1>Build and test repositories in App</h1>
                        <p>Titan Designer brings powerful web apps and native experiences to iOS and Android.</p>
                        <div class="gradient-background"></div>
                        <div class="triangle-overlay"></div>
                    </div>
                </main>
            </div>
            <div class="footer">
                Titan Developments Software | All Rights Reserved &copy; 2025
            </div>
        </div>
        <div class="fade-overlay"></div>
    </div>
    
    <div id="code-editor-container"></div>

    <div id="new-file-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">Create New File..</h2>
            <input type="text" id="file-name-input" placeholder="file.js" autocapitalize="off" spellcheck="false" />
            <div class="modal-actions">
                <button id="cancel-button">Cancel</button>
                <button id="confirm-button" disabled>Confirm</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="file-upload" style="display: none;" />
    
    <script>
        // File: plugins/css.js
        const escapeHtml_css = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        const plugin_css = {
          colors: {
            selector: '#22863A',  // Green for selectors
            property: '#6F42C1',  // Purple for properties
            value: '#005CC5',     // Blue for values
            string: '#067D17',    // Green for strings
            comment: '#8C8C8C',   // Gray for comments
            operator: '#DE5833',  // Orange for operators (:, ;, {})
            atrule: '#D73A49',    // Red for @rules
            pseudo: '#1750EB',    // Blue for :pseudo
            variable: '#24292E',  // Dark gray for var(--)
          },
          patterns: [
            { type: 'comment', regex: /\/\*[\s\S]*?\*\//g },
            { type: 'string', regex: /"[^"]*"/g },
            { type: 'string', regex: /\'[^\']*\'/g },
            { type: 'atrule', regex: /@[\w-]+/g },
            { type: 'selector', regex: /([^\s;{}]+)(?=\s*\{)/g },
            { type: 'pseudo', regex: /:[\w-]+/g },
            { type: 'property', regex: /([\w-]+)(?=\s*:)/g },
            { type: 'value', regex: /:\s*([^;]+)(?=;)/g },
            { type: 'variable', regex: /var\(--[\w-]+\)/g },
            { type: 'operator', regex: /[:;{}]/g },
          ],
          highlight: function(code) {
            let html = escapeHtml_css(code);
            this.patterns.forEach(pat => {
              html = html.replace(pat.regex, match => `<span style="color:${this.colors[pat.type]};">${match}</span>`);
            });
            return html;
          },
          lint: function(code) {
            const errors = [];
            const stack = [];
            let inAtRule = false;
            code.split('').forEach((c, i) => {
              if (c === '{') {
                stack.push(c);
                if (/@/.test(code.slice(i-10, i))) inAtRule = true;
              } else if (c === '}') {
                if (stack.pop() !== '{') errors.push(`Mismatched brace at position ${i + 1}`);
                if (stack.length === 0) inAtRule = false;
              }
            });
            if (stack.length) errors.push(`Unclosed braces: ${stack.length} remaining`);
            code.split(';').forEach(dec => {
              if (dec.trim() && !/:/.test(dec)) errors.push(`Invalid declaration (missing :): ${dec.trim()}`);
            });
            return errors;
          }
        };


        // File: plugins/html.js
        const escapeHtml_html = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        const plugin_html = {
          colors: {
            tag: '#22863A',       // Green for tags
            attribute: '#6F42C1', // Purple for attributes
            string: '#067D17',    // Green for strings
            comment: '#8C8C8C',   // Gray for comments
            operator: '#DE5833',  // Orange for operators (e.g., =)
            doctype: '#D73A49',   // Red for <!DOCTYPE>
            entity: '#1750EB',    // Blue for &entities;
          },
          patterns: [
            { type: 'comment', regex: //g },
            { type: 'doctype', regex: /<!DOCTYPE[^>]*>/gi },
            { type: 'string', regex: /="[^"]*"/g },
            { type: 'string', regex: /='[^']*'/g },
            { type: 'tag', regex: /<\/?[\w-]+/g },
            { type: 'attribute', regex: /\b[\w-]+(?==)/g },
            { type: 'operator', regex: /=/g },
            { type: 'entity', regex: /&[\w]+;/g },
          ],
          highlight: function(code) {
            let html = escapeHtml_html(code);
            this.patterns.forEach(pat => {
              html = html.replace(pat.regex, match => `<span style="color:${this.colors[pat.type]};">${match}</span>`);
            });
            html = html.replace(/<script[^>]*>([\s\S]*?)<\/script>/gi, (match, jsCode) => {
              const jsPlugin = { highlight: (c) => c.replace(/(function|return)/g, '<span style="color:#0033B3;">$&</span>') };
              return match.replace(jsCode, jsPlugin.highlight(escapeHtml_html(jsCode)));
            });
            html = html.replace(/<style[^>]*>([\s\S]*?)<\/style>/gi, (match, cssCode) => {
              const cssPlugin = { highlight: (c) => c.replace(/([a-z-]+)(?=:)/g, '<span style="color:#6F42C1;">$&</span>') };
              return match.replace(cssCode, cssPlugin.highlight(escapeHtml_html(cssCode)));
            });
            return html;
          },
          lint: function(code) {
            const errors = [];
            const stack = [];
            const tagRegex = /<(\/)?([\w-]+)[^>]*>/g;
            let match;
            while ((match = tagRegex.exec(code)) !== null) {
              const isClose = match[1];
              const tag = match[2].toLowerCase();
              if (isClose) {
                if (stack.length === 0 || stack.pop() !== tag) {
                  errors.push(`Mismatched closing tag </${tag}> at position ${match.index + 1}`);
                }
              } else if (!['br', 'hr', 'img', 'input', 'link', 'meta', 'area', 'base', 'col', 'embed', 'param', 'source', 'track', 'wbr'].includes(tag)) {
                stack.push(tag);
              }
            }
            if (stack.length > 0) errors.push(`Unclosed tags: ${stack.join(', ')}`);
            if (!/<!DOCTYPE html>/i.test(code)) errors.push('Missing or incorrect DOCTYPE declaration');
            return errors;
          }
        };


        // File: plugins/js.js
        const escapeHtml_js = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        const plugin_js = {
          colors: {
            keyword: '#0033B3',   // Deep blue for keywords
            string: '#067D17',    // Green for strings
            comment: '#8C8C8C',   // Gray for comments
            number: '#1750EB',    // Blue for numbers
            function: '#6F42C1',  // Purple for functions
            operator: '#DE5833',  // Orange for operators
            variable: '#24292E',  // Dark gray for variables
            punctuation: '#24292E', // Dark gray for punctuation
            class: '#22863A',     // Green for class names
            module: '#D73A49',    // Red for import/export modules
          },
          patterns: [
            { type: 'comment', regex: /(\/\/.*$|\/\*[\s\S]*?\*\/)/gm },
            { type: 'string', regex: /"(?:[^"\\]|\\.)*"/g },
            { type: 'string', regex: /'(?:[^'\\]|\\.)*'/g },
            { type: 'string', regex: /`(?:[^`\\]|\\.)*`/g },
            { type: 'number', regex: /\b-?\d+\.?\d*(?:e[+-]?\d+)?\b/gi },
            { type: 'keyword', regex: /\b(var|let|const|function|return|if|else|for|while|do|switch|case|break|continue|new|class|try|catch|throw|finally|async|await|import|export|from|as|default|true|false|null|undefined|typeof|instanceof|this|super|extends|static|delete|in|of|yield|void|debugger|with|implements|interface|package|private|protected|public|enum|declare|readonly|abstract|override|namespace|type|keyof|infer|never|unknown|any|asserts|is|module|require|global|augment)\b/g },
            { type: 'class', regex: /\bclass\s+([a-z_]\w*)\b/gi },
            { type: 'function', regex: /\b([a-z_]\w*)\s*(?=\()/gi },
            { type: 'module', regex: /(import|export|from|as|default)\b/g },
            { type: 'operator', regex: /[-+*%&|/!<>=?:;]/g },
            { type: 'punctuation', regex: /[{}[\](),.]/g },
            { type: 'variable', regex: /\b([a-z_]\w*)\b/gi },
          ],
          highlight: function(code) {
            let html = escapeHtml_js(code);
            this.patterns.forEach(pat => {
              html = html.replace(pat.regex, (match, ...groups) => {
                const color = groups.length > 0 && groups[0] ? this.colors[pat.type] : this.colors[pat.type];
                return `<span style="color:${color};">${match}</span>`;
              });
            });
            return html;
          },
          lint: function(code) {
            const errors = [];
            const stack = [];
            const parens = { '(': ')', '[': ']', '{': '}' };
            let inString = false, stringChar;
            code.split('').forEach((c, i) => {
              if (inString) {
                if (c === stringChar && code[i-1] !== '\\') inString = false;
              } else {
                if (['"', "'", '`'].includes(c)) { inString = true; stringChar = c; }
                else if (Object.keys(parens).includes(c)) stack.push(c);
                else if (Object.values(parens).includes(c)) {
                  if (parens[stack.pop()] !== c) errors.push(`Mismatched parenthesis at position ${i + 1}`);
                }
              }
            });
            if (stack.length) errors.push(`Unclosed parentheses: ${stack.length} remaining`);
            if (inString) errors.push('Unclosed string');
            if (!/;\s*$/.test(code.trim()) && !/\}$/.test(code.trim())) errors.push('Possibly missing semicolon at end');
            return errors;
          }
        };


        // File: plugins/json.js
        const escapeHtml_json = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        const plugin_json = {
          colors: {
            keyword: '#0033B3',   // Deep blue for true/false/null
            string: '#067D17',    // Green for strings
            number: '#1750EB',    // Blue for numbers
            operator: '#DE5833',  // Orange for : , [ ] { }
            punctuation: '#24292E', // Dark gray for , :
          },
          patterns: [
            { type: 'string', regex: /"(?:[^"\\]|\\.)*"/g },
            { type: 'number', regex: /\b-?\d+\.?\d*(?:e[+-]?\d+)?\b/gi },
            { type: 'keyword', regex: /\b(true|false|null)\b/g },
            { type: 'punctuation', regex: /[:,]/g },
            { type: 'operator', regex: /[{}[\]]/g },
          ],
          highlight: function(code) {
            let html = escapeHtml_json(code);
            this.patterns.forEach(pat => {
              html = html.replace(pat.regex, match => `<span style="color:${this.colors[pat.type]};">${match}</span>`);
            });
            return html;
          },
          lint: function(code) {
            try {
              JSON.parse(code);
              return [];
            } catch (e) {
              return [e.message];
            }
          }
        };


        // File: plugins/jsx.js
        const escapeHtml_jsx = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        const plugin_jsx = {
          colors: {
            keyword: '#0033B3',   // Deep blue for keywords
            string: '#067D17',    // Green for strings
            comment: '#8C8C8C',   // Gray for comments
            number: '#1750EB',    // Blue for numbers
            function: '#6F42C1',  // Purple for functions
            operator: '#DE5833',  // Orange for operators
            variable: '#24292E',  // Dark gray for variables
            tag: '#22863A',       // Green for JSX tags
            attribute: '#6F42C1', // Purple for JSX attributes
            punctuation: '#24292E', // Dark gray for punctuation
          },
          patterns: [
            { type: 'comment', regex: /(\/\/.*$|\/\*[\s\S]*?\*\/)/gm },
            { type: 'string', regex: /"(?:[^"\\]|\\.)*"/g },
            { type: 'string', regex: /'(?:[^'\\]|\\.)*'/g },
            { type: 'string', regex: /`(?:[^`\\]|\\.)*`/g },
            { type: 'number', regex: /\b-?\d+\.?\d*(?:e[+-]?\d+)?\b/gi },
            { type: 'keyword', regex: /\b(var|let|const|function|return|if|else|for|while|do|switch|case|break|continue|new|class|try|catch|throw|finally|async|await|import|export|from|true|false|null|undefined|typeof|instanceof|this|super|extends|static|React|useState|useEffect)\b/g },
            { type: 'function', regex: /\b([a-z_]\w*)\s*(?=\()/gi },
            { type: 'operator', regex: /[-+*%&|/!<>=?:;]/g },
            { type: 'tag', regex: /<\/?[\w.]+/g },
            { type: 'attribute', regex: /\b[\w-]+(?==|{)/g },
            { type: 'punctuation', regex: /[{}[\](),.]/g },
            { type: 'variable', regex: /\b([a-z_]\w*)\b/gi },
          ],
          highlight: function(code) {
            let html = escapeHtml_jsx(code);
            this.patterns.forEach(pat => {
              html = html.replace(pat.regex, match => `<span style="color:${this.colors[pat.type]};">${match}</span>`);
            });
            html = html.replace(/\{([\s\S]*?)\}/g, (match, jsExpr) => {
              const highlightedExpr = jsExpr.replace(/\b(return|if)\b/g, '<span style="color:#0033B3;">$&</span>');
              return `{${highlightedExpr}}`;
            });
            return html;
          },
          lint: function(code) {
            const errors = [];
            const jsxStack = [];
            const parensStack = [];
            const parens = { '(': ')', '[': ']', '{': '}' };
            let inString = false, stringChar, inJsx = false;
            code.split('').forEach((c, i) => {
              if (inString) {
                if (c === stringChar && code[i-1] !== '\\') inString = false;
              } else {
                if (['"', "'", '`'].includes(c)) { inString = true; stringChar = c; return; }
                if (c === '<' && /[a-zA-Z]/.test(code[i+1])) { inJsx = true; jsxStack.push('<'); }
                else if (c === '>' && inJsx) { if (jsxStack.pop() !== '<') errors.push(`Mismatched JSX tag at ${i + 1}`); if (jsxStack.length === 0) inJsx = false; }
                else if (Object.keys(parens).includes(c)) parensStack.push(c);
                else if (Object.values(parens).includes(c)) {
                  if (parens[parensStack.pop()] !== c) errors.push(`Mismatched parenthesis at position ${i + 1}`);
                }
              }
            });
            if (parensStack.length) errors.push(`Unclosed parentheses: ${parensStack.length} remaining`);
            if (jsxStack.length) errors.push(`Unclosed JSX tags: ${jsxStack.length} remaining`);
            if (inString) errors.push('Unclosed string');
            return errors;
          }
        };


        // File: plugins/md.js
        const escapeHtml_md = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        const plugin_md = {
          colors: {
            header: '#0033B3',    // Deep blue for # headers
            link: '#22863A',      // Green for [links](url)
            code: '#6F42C1',      // Purple for `code` and code blocks
            bold: '#D73A49',      // Red for **bold**
            italic: '#1750EB',    // Blue for *italic*
            list: '#DE5833',      // Orange for - lists
            quote: '#8C8C8C',     // Gray for > quotes
            image: '#067D17',     // Green for ![alt](url)
          },
          patterns: [
            { type: 'header', regex: /^(#{1,6})\s+.*/gm },
            { type: 'bold', regex: /\*\*(.*?)\*\*/g },
            { type: 'italic', regex: /\*(.*?)\*/g },
            { type: 'code', regex: /`([^`]+)`/g },
            { type: 'code', regex: /```[\s\S]*?```/g },
            { type: 'link', regex: /\[([^\]]+)\]\(([^)]+)\)/g },
            { type: 'image', regex: /!\[([^\]]+)\]\(([^)]+)\)/g },
            { type: 'list', regex: /^(\s*[-*+]\s+)/gm },
            { type: 'quote', regex: /^>\s+.*/gm },
          ],
          highlight: function(code) {
            let html = escapeHtml_md(code);
            this.patterns.forEach(pat => {
              html = html.replace(pat.regex, match => `<span style="color:${this.colors[pat.type]};font-weight:${pat.type === 'header' || pat.type === 'bold' ? 'bold' : 'normal'};font-style:${pat.type === 'italic' ? 'italic' : 'normal'};">${match}</span>`);
            });
            return html;
          },
          lint: function(code) {
            const errors = [];
            const lines = code.split('\n');
            lines.forEach((line, i) => {
              if (/^#{7,}/.test(line)) errors.push(`Header level too deep at line ${i + 1} (max 6)`);
              if (/\[([^\]]+)\]\(([^)]*)\)/.test(line) && !/^https?:\/\//.test(RegExp.$2)) errors.push(`Invalid link URL at line ${i + 1}`);
            });
            if (code.match(/\*\*(?![^*]*\*\*)/g)) errors.push('Unmatched bold markup');
            if (code.match(/\*(?![^*]*\*)/g)) errors.push('Unmatched italic markup');
            return errors;
          }
        };


        // File: plugins/scss.js
        const escapeHtml_scss = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        const plugin_scss = {
          colors: {
            selector: '#22863A',  // Green for selectors
            property: '#6F42C1',  // Purple for properties
            value: '#005CC5',     // Blue for values
            string: '#067D17',    // Green for strings
            comment: '#8C8C8C',   // Gray for comments
            operator: '#DE5833',  // Orange for operators (:, ;, {})
            atrule: '#D73A49',    // Red for @rules (@mixin, @include)
            variable: '#24292E',  // Dark gray for $variables
            pseudo: '#1750EB',    // Blue for :pseudo
          },
          patterns: [
            { type: 'comment', regex: /\/\*[\s\S]*?\*\//g },
            { type: 'string', regex: /"[^"]*"/g },
            { type: 'string', regex: /\'[^\']*\'/g },
            { type: 'atrule', regex: /@(mixin|include|extend|if|else|each|while|for|function|return|import|media|keyframes|content)/g },
            { type: 'selector', regex: /([^\s;{}&+>~]+)(?=\s*\{)/g },
            { type: 'pseudo', regex: /:[\w-]+/g },
            { type: 'property', regex: /([\w-]+)(?=\s*:)/g },
            { type: 'value', regex: /:\s*([^;]+)(?=;)/g },
            { type: 'variable', regex: /\$[\w-]+/g },
            { type: 'operator', regex: /[:;{}&+>~]/g },
          ],
          highlight: function(code) {
            let html = escapeHtml_scss(code);
            this.patterns.forEach(pat => {
              html = html.replace(pat.regex, match => `<span style="color:${this.colors[pat.type]};">${match}</span>`);
            });
            return html;
          },
          lint: function(code) {
            const errors = [];
            const stack = [];
            code.split('').forEach((c, i) => {
              if (c === '{') stack.push(c);
              else if (c === '}') {
                if (stack.pop() !== '{') errors.push(`Mismatched brace at position ${i + 1}`);
              }
            });
            if (stack.length) errors.push(`Unclosed braces: ${stack.length} remaining`);
            const varsDefined = new Set(code.match(/\$[\w-]+(?=\s*:)/g) || []);
            const varsUsed = code.match(/\$[\w-]+/g) || [];
            varsUsed.forEach(v => {
              if (!varsDefined.has(v)) errors.push(`Possibly undefined variable: ${v}`);
            });
            return errors;
          }
        };


        // File: plugins/svg.js
        const escapeHtml_svg = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        const plugin_svg = {
          colors: {
            tag: '#22863A',       // Green for tags (e.g., <svg>, <path>)
            attribute: '#6F42C1', // Purple for attributes (e.g., viewBox)
            string: '#067D17',    // Green for strings
            comment: '#8C8C8C',   // Gray for comments
            operator: '#DE5833',  // Orange for =
            pathdata: '#005CC5',  // Blue for d="..." path data
          },
          patterns: [
            { type: 'comment', regex: //g },
            { type: 'string', regex: /="[^"]*"/g },
            { type: 'string', regex: /='[^']*'/g },
            { type: 'tag', regex: /<\/?(svg|path|rect|circle|ellipse|line|polyline|polygon|g|defs|use|symbol|image|text|textPath|tspan|clipPath|mask|filter|fe[a-z]+|animate|set|metadata)/gi },
            { type: 'attribute', regex: /\b(viewBox|width|height|d|cx|cy|r|x|y|x1|y1|x2|y2|points|transform|fill|stroke|stroke-width|opacity|id|class|style)(?==)/gi },
            { type: 'operator', regex: /=/g },
            { type: 'pathdata', regex: /d="([MmLlHhVvCcSsQqTtAaZz0-9.,\s]+)"/gi },
          ],
          highlight: function(code) {
            let html = escapeHtml_svg(code);
            this.patterns.forEach(pat => {
              html = html.replace(pat.regex, (match, data) => {
                if (data) {
                  const highlightedData = data.replace(/([MmLlHhVvCcSsQqTtAaZz])/g, '<span style="color:#D73A49;">$&</span>');
                  return match.replace(data, highlightedData);
                }
                return `<span style="color:${this.colors[pat.type]};">${match}</span>`;
              });
            });
            return html;
          },
          lint: function(code) {
            const errors = [];
            const stack = [];
            const tagRegex = /<(\/)?([\w-]+)[^>]*>/g;
            let match;
            while ((match = tagRegex.exec(code)) !== null) {
              const isClose = match[1];
              const tag = match[2].toLowerCase();
              if (isClose) {
                if (stack.length === 0 || stack.pop() !== tag) {
                  errors.push(`Mismatched closing tag </${tag}> at position ${match.index + 1}`);
                }
              } else {
                stack.push(tag);
              }
            }
            if (stack.length > 0) errors.push(`Unclosed tags: ${stack.join(', ')}`);
            if (!/<svg/.test(code)) errors.push('Missing root <svg> tag');
            return errors;
          }
        };


        // File: plugins/ts.js
        const escapeHtml_ts = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        const plugin_ts = {
          colors: {
            keyword: '#0033B3',   // Deep blue for keywords
            string: '#067D17',    // Green for strings
            comment: '#8C8C8C',   // Gray for comments
            number: '#1750EB',    // Blue for numbers
            function: '#6F42C1',  // Purple for functions
            operator: '#DE5833',  // Orange for operators
            variable: '#24292E',  // Dark gray for variables
            punctuation: '#24292E', // Dark gray for punctuation
            type: '#22863A',      // Green for types
            interface: '#D73A49', // Red for interface/type names
          },
          patterns: [
            { type: 'comment', regex: /(\/\/.*$|\/\*[\s\S]*?\*\/)/gm },
            { type: 'string', regex: /"(?:[^"\\]|\\.)*"/g },
            { type: 'string', regex: /'(?:[^'\\]|\\.)*'/g },
            { type: 'string', regex: /`(?:[^`\\]|\\.)*`/g },
            { type: 'number', regex: /\b-?\d+\.?\d*(?:e[+-]?\d+)?\b/gi },
            { type: 'keyword', regex: /\b(var|let|const|function|return|if|else|for|while|do|switch|case|break|continue|new|class|try|catch|throw|finally|async|await|import|export|from|as|default|true|false|null|undefined|typeof|instanceof|this|super|extends|static|delete|in|of|yield|void|debugger|with|implements|interface|package|private|protected|public|enum|declare|readonly|abstract|override|namespace|type|keyof|infer|never|unknown|any|asserts|is|module|require|global|augment)\b/g },
            { type: 'interface', regex: /\b(interface|type)\s+([a-z_]\w*)\b/gi },
            { type: 'function', regex: /\b([a-z_]\w*)\s*(?=\()/gi },
            { type: 'type', regex: /\b(string|number|boolean|any|void|unknown|never|object|Array|Promise|Record|Partial|Pick|Omit)\b/g },
            { type: 'operator', regex: /[-+*%&|/!<>=?:;]/g },
            { type: 'punctuation', regex: /[{}[\](),.]/g },
            { type: 'variable', regex: /\b([a-z_]\w*)\b/gi },
          ],
          highlight: function(code) {
            let html = escapeHtml_ts(code);
            this.patterns.forEach(pat => {
              html = html.replace(pat.regex, match => `<span style="color:${this.colors[pat.type]};">${match}</span>`);
            });
            return html;
          },
          lint: function(code) {
            const errors = [];
            const stack = [];
            const parens = { '(': ')', '[': ']', '{': '}' };
            let inString = false, stringChar;
            code.split('').forEach((c, i) => {
              if (inString) {
                if (c === stringChar && code[i-1] !== '\\') inString = false;
              } else {
                if (['"', "'", '`'].includes(c)) { inString = true; stringChar = c; }
                else if (Object.keys(parens).includes(c)) stack.push(c);
                else if (Object.values(parens).includes(c)) {
                  if (parens[stack.pop()] !== c) errors.push(`Mismatched parenthesis at position ${i + 1}`);
                }
              }
            });
            if (stack.length) errors.push(`Unclosed parentheses: ${stack.length} remaining`);
            if (inString) errors.push('Unclosed string');
            if (/\b(let|const|var)\s+[a-z_]\w*\s*(?=[=;])/gi.test(code)) errors.push('Possibly missing type annotation');
            return errors;
          }
        };


        // File: plugins/xml.js
        const escapeHtml_xml = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        const plugin_xml = {
          colors: {
            tag: '#22863A',       // Green for tags
            attribute: '#6F42C1', // Purple for attributes
            string: '#067D17',    // Green for strings
            comment: '#8C8C8C',   // Gray for comments
            operator: '#DE5833',  // Orange for =
            cdata: '#005CC5',     // Blue for <![CDATA[]]>
            pi: '#D73A49',        // Red for <?xml ?>
          },
          patterns: [
            { type: 'comment', regex: //g },
            { type: 'cdata', regex: /<!\[CDATA\[[\s\S]*?\]\]>/g },
            { type: 'pi', regex: /<\?[\s\S]*?\?>/g },
            { type: 'string', regex: /="[^"]*"/g },
            { type: 'string', regex: /='[^']*'/g },
            { type: 'tag', regex: /<\/?[\w:-]+/g },
            { type: 'attribute', regex: /\b[\w:-]+(?==)/g },
            { type: 'operator', regex: /=/g },
          ],
          highlight: function(code) {
            let html = escapeHtml_xml(code);
            this.patterns.forEach(pat => {
              html = html.replace(pat.regex, match => `<span style="color:${this.colors[pat.type]};">${match}</span>`);
            });
            return html;
          },
          lint: function(code) {
            const errors = [];
            const stack = [];
            const tagRegex = /<(\/)?([\w:-]+)[^>]*>/g;
            let match;
            while ((match = tagRegex.exec(code)) !== null) {
              const isClose = match[1];
              const tag = match[2].toLowerCase();
              if (isClose) {
                if (stack.length === 0 || stack.pop() !== tag) {
                  errors.push(`Mismatched closing tag </${tag}> at position ${match.index + 1}`);
                }
              } else {
                stack.push(tag);
              }
            }
            if (stack.length > 0) errors.push(`Unclosed tags: ${stack.join(', ')}`);
            if (!/<\?xml/.test(code)) errors.push('Missing XML declaration');
            return errors;
          }
        };


        // File: plugins/yaml.js
        const escapeHtml_yaml = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        const plugin_yaml = {
          colors: {
            key: '#6F42C1',       // Purple for keys
            string: '#067D17',    // Green for strings
            number: '#1750EB',    // Blue for numbers
            comment: '#8C8C8C',   // Gray for comments
            operator: '#DE5833',  // Orange for : - |
            anchor: '#D73A49',    // Red for &anchors *aliases
            boolean: '#0033B3',   // Deep blue for true/false
          },
          patterns: [
            { type: 'comment', regex: /#.*$/gm },
            { type: 'anchor', regex: /&[\w-]+|\*[\w-]+/g },
            { type: 'string', regex: /:\s*["'][^"']*["']/g },
            { type: 'string', regex: /:\s*\|[\s\S]*?(?=\n\S|$)/g },
            { type: 'string', regex: /:\s*>\s*[\s\S]*?(?=\n\S|$)/g },
            { type: 'number', regex: /:\s*[-+]?\d+\.?\d*(?:e[+-]?\d+)?\b/g },
            { type: 'boolean', regex: /:\s*(true|false|yes|no|on|off)\b/gi },
            { type: 'key', regex: /^(\s*[\w-]+):/gm },
            { type: 'operator', regex: /[:\-|>/]/g },
          ],
          highlight: function(code) {
            let html = escapeHtml_yaml(code);
            this.patterns.forEach(pat => {
              html = html.replace(pat.regex, match => `<span style="color:${this.colors[pat.type]};">${match}</span>`);
            });
            return html;
          },
          lint: function(code) {
            const errors = [];
            const lines = code.split('\n');
            let indentStack = [0];
            lines.forEach((line, i) => {
              if (line.trim() === '' || line.trim().startsWith('#')) return;
              const currentIndent = line.match(/^\s*/)[0].length;
              if (currentIndent < indentStack[indentStack.length - 1]) {
                while (currentIndent < indentStack[indentStack.length - 1]) indentStack.pop();
                if (currentIndent !== indentStack[indentStack.length - 1]) errors.push(`Indent mismatch at line ${i + 1}`);
              } else if (currentIndent > indentStack[indentStack.length - 1]) {
                indentStack.push(currentIndent);
              }
              if (/:$/.test(line.trim())) errors.push(`Missing value after colon at line ${i + 1}`);
              if (/^-\s/.test(line) && currentIndent !== indentStack[indentStack.length - 1]) errors.push(`Sequence indent error at line ${i + 1}`);
            });
            return errors;
          }
        };

        // app.js
        document.addEventListener('DOMContentLoaded', () => {

            const appState = {
                db: null,
                currentFile: null
            };

            // --- Main Page UI & Logic ---
            const pageStyles = `
                /* Base styles and layout for mobile */
                body {
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
                    margin: 0;
                    background-color: #000;
                    color: #fff;
                    height: 100vh;
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                }

                .main-content-scroll {
                    flex-grow: 1;
                    overflow: hidden;
                    -webkit-overflow-scrolling: touch;
                }

                header {
                    display: flex;
                    justify-content: flex-start;
                    align-items: center;
                    padding: 20px 40px;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
                    z-index: 10;
                }

                .logo {
                    font-size: 24px;
                    font-weight: bold;
                    display: flex;
                    align-items: center;
                }

                .logo svg {
                    margin-right: 10px;
                    width: 32px;
                    height: 32px;
                    fill: white;
                }

                .alert-banner {
                    background-color: #000;
                    text-align: center;
                    padding: 15px 0;
                    border-bottom: 1px solid #333;
                    z-index: 5;
                }

                .alert-banner p {
                    margin: 5px 0;
                    font-size: 16px;
                }

                .footer {
                    text-align: center;
                    padding: 20px 0;
                    font-size: 12px;
                    color: #aaa;
                    background-color: #000;
                    z-index: 10;
                    position: relative;
                    margin-top: -50px;
                }

                @media (max-width: 768px) {
                    header {
                        padding: 15px 20px;
                    }
                }

                /* New banner and button CSS */
                .page-content-wrapper {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    flex-grow: 1;
                    padding-bottom: 50px;
                }

                #action-button-wrapper {
                    margin-top: 20px;
                }

                .transform-button-container {
                    position: relative;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    width: 250px;
                    height: 50px;
                    transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
                    border-radius: 50px;
                    background-color: #fff;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
                    cursor: pointer;
                    z-index: 999;
                }

                .transform-button-container.active {
                    border-radius: 10px;
                }

                .button-label {
                    color: #000;
                    font-weight: bold;
                    font-size: 16px;
                    white-space: nowrap;
                    transition: opacity 0.3s ease, transform 0.3s ease;
                }

                .transform-button-container.active .button-label {
                    opacity: 0;
                    transform: translateY(-20px);
                    pointer-events: none;
                }

                .transform-dropdown-menu {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 50px;
                    list-style: none;
                    padding: 0;
                    margin: 0;
                    opacity: 0;
                    visibility: hidden;
                    pointer-events: none;
                    transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
                    background-color: #fff;
                    border-radius: 50px;
                }

                .transform-button-container.active .transform-dropdown-menu {
                    opacity: 1;
                    visibility: visible;
                    pointer-events: auto;
                    height: 200px;
                    border-radius: 10px;
                }

                .transform-dropdown-menu li {
                    position: relative;
                    width: 100%;
                    height: 50px;
                    display: flex;
                    align-items: center;
                }

                .transform-dropdown-menu li:not(:last-child) {
                    box-shadow: 0 2px 4px -2px rgba(0, 0, 0, 0.15);
                }

                .transform-dropdown-menu li a {
                    display: flex;
                    align-items: center;
                    width: 100%;
                    height: 100%;
                    font-weight: bold;
                    color: #000;
                    text-decoration: none;
                    font-size: 14px;
                    padding: 0 10%;
                    border-radius: 5px;
                    text-align: left;
                    box-sizing: border-box;
                    transition: background-color 0.1s ease, transform 0.1s ease;
                }

                .transform-dropdown-menu li a:active {
                    background-color: #e0e0e0;
                    transform: scale(0.98);
                }

                .hero-section {
                    padding: 80px 40px;
                    text-align: center;
                    margin-top: 0;
                    margin-bottom: 0;
                    position: relative;
                    z-index: 5;
                    flex-grow: 1;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                }

                .hero-content {
                    background-color: #1a1a1a;
                    padding: 70px 40px 70px;
                    border-radius: 10px;
                    max-width: 800px;
                    margin: 0 auto;
                    position: relative;
                    overflow: hidden;
                    z-index: 2;
                }

                .hero-content h1 {
                    font-size: 48px;
                    margin-top: -30px;
                    margin-bottom: 0;
                    line-height: 1.2;
                    color: #fff;
                }

                .hero-content p {
                    font-size: 18px;
                    line-height: 1.6;
                    margin-bottom: 0;
                    max-width: 600px;
                    margin-left: auto;
                    margin-right: auto;
                    color: #000;
                    font-weight: bold;
                    position: relative;
                    z-index: 3;
                    margin-top: 20px;
                }

                .gradient-background {
                    position: absolute;
                    bottom: -70px;
                    left: 0;
                    width: 100%;
                    height: 250px;
                    background: linear-gradient(to right, #ff4500, #ffa500, #ffd700, #ffff00);
                    mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
                    -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
                    z-index: 0;
                }

                .triangle-overlay {
                    position: absolute;
                    bottom: -70px;
                    left: 50%;
                    transform: translateX(-50%) translateY(50%);
                    width: 80px;
                    height: 80px;
                    background-color: #000;
                    clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
                    z-index: 1;
                }

                .fade-overlay {
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    width: 100%;
                    height: 150px;
                    background: linear-gradient(to top, rgba(0, 0, 0, 1) 0%, rgba(0, 0, 0, 0) 100%);
                    z-index: 1;
                    pointer-events: none;
                }

                @media (max-width: 768px) {
                    .hero-content {
                        padding: 70px 20px 60px;
                    }
                    .hero-content h1 {
                        font-size: 36px;
                    }
                    .hero-content p {
                        font-size: 16px;
                    }
                }

                /* --- Modal Styles --- */
                .modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.6);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                    visibility: hidden;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                }

                .modal-overlay.visible {
                    visibility: visible;
                    opacity: 1;
                }

                .modal-content {
                    background-color: #000;
                    border: none;
                    padding: 20px;
                    border-radius: 10px;
                    text-align: center;
                    transform: scale(0.7);
                    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
                    margin-top: -80px;
                }

                .modal-overlay.visible .modal-content {
                    transform: scale(1);
                }

                .modal-title {
                    color: #fff;
                    font-size: 20px;
                    margin-bottom: 20px;
                }

                #file-name-input {
                    width: 200px;
                    padding: 10px;
                    border: none;
                    background-color: #fff;
                    color: #000;
                    border-radius: 5px;
                    text-align: center;
                    font-size: 16px;
                    outline: none;
                }

                .modal-actions {
                    margin-top: 20px;
                    display: flex;
                    justify-content: center;
                }

                .modal-actions button {
                    border: none;
                    padding: 10px 20px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-weight: bold;
                    margin: 0 5px;
                    transition: background-color 0.2s ease, color 0.2s ease;
                }

                #cancel-button {
                    background-color: #dc3545;
                    color: #fff;
                }

                #confirm-button {
                    background-color: #fff;
                    color: #000;
                }

                #confirm-button:disabled {
                    background-color: #555;
                    color: #aaa;
                    cursor: not-allowed;
                }
            `;

            // Injects the CSS styles into the document's head
            function injectStyles(styles) {
                const styleTag = document.createElement('style');
                styleTag.textContent = styles;
                document.head.appendChild(styleTag);
            }

            // Mocking placeholder for repository manager logic
            const repoManager = {
                openRepo: function(repoName) {
                    console.log(`Opening new repository: ${repoName}`);
                    console.log(`Sliding in the repo root page...`);
                },
                unpackAndOpenRepo: function(zipFileName) {
                    console.log(`Attempting to unpack zip file: ${zipFileName}`);
                    console.log(`Simulating unpacking...`);
                    console.log(`Successfully unpacked contents into a new repository.`);
                    this.openRepo(zipFileName.replace('.zip', ''));
                }
            };
            
            // --- Code Editor UI & Logic ---
            const editorHtmlContent = `
                <div class="app-container">
                    <header>
                        <div class="logo">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-13c-.83 0-1.5-.67-1.5-1.5S11.17 5 12 5s1.5.67 1.5 1.5S12.83 7 12 7zm0 10c-.83 0-1.5-.67-1.5-1.5S11.17 14 12 14s1.5.67 1.5 1.5S12.83 17 12 17zm0-5c-2.76 0-5 2.24-5 5h3c0-1.1.9-2 2-2s2 .9 2 2h3c0-2.76-2.24-5-5-5zM9 13c-.55 0-1 .45-1 1s.45 1 1 1h.5v-2H9zm6 0v2h.5c.55 0 1-.45 1-1s-.45-1-1-1H15zM7 9v1h2V9H7zm8 0v1h2V9h-2z"/>
                            </svg>
                            Titan Designer
                        </div>
                        <button class="close-btn editor-close-btn">&times;</button>
                    </header>
                    <div class="code-editor">
                        <div class="editor-header">
                            <h3 id="current-file-name"></h3>
                            <div class="editor-header-right">
                                <button id="select-all-button" class="icon-button" title="Select All">
                                    <i class="fas fa-solid fa-file-invoice"></i>
                                </button>
                                <button id="copy-button" class="icon-button" title="Copy">
                                    <i class="fas fa-solid fa-copy"></i>
                                </button>
                                <button id="paste-button" class="icon-button" title="Paste">
                                    <i class="fas fa-solid fa-paste"></i>
                                </button>
                                <button id="download-button" class="icon-button" title="Download">
                                    <i class="fas fa-solid fa-download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="editor-content">
                            <div class="number-bar"></div>
                            <textarea id="code-textarea" class="code-textarea" autocapitalize="none"></textarea>
                        </div>
                    </div>
                </div>
                <div id="modal-overlay" class="modal-overlay">
                    <div id="modal-box" class="modal-box">
                        <h3>Download File!</h3>
                        <p>This app does not save locally. Please download your file to a device or service to save it.</p>
                        <div class="modal-buttons">
                            <button id="download-modal-btn" class="modal-button">Download</button>
                            <button id="close-modal-btn" class="modal-button">Close</button>
                        </div>
                    </div>
                </div>
            `;

            const editorCssContent = `
                @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap');
                
                /* General editor styling */
                .app-container {
                    width: 100%;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    position: relative;
                }

                header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px 40px;
                    background-color: #000;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
                    z-index: 10;
                }

                .logo {
                    font-size: 24px;
                    font-weight: bold;
                    display: flex;
                    align-items: center;
                    color: white;
                }

                .logo svg {
                    margin-right: 10px;
                    width: 32px;
                    height: 32px;
                    fill: white;
                }

                .code-editor {
                    width: 100%;
                    flex-grow: 1;
                    display: flex;
                    flex-direction: column;
                    position: relative;
                }

                .editor-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 10px 20px;
                    background-color: #1a1a1a;
                    border-bottom: 1px solid #333;
                    position: relative;
                    z-index: 2;
                }
                
                .editor-header h3 {
                    margin: 0;
                    font-size: 18px;
                    color: #fff;
                    overflow: hidden;
                    white-space: nowrap;
                    text-overflow: ellipsis;
                }

                .editor-header-right {
                    display: flex;
                    align-items: center;
                    gap: 15px;
                    position: relative;
                    z-index: 1;
                }

                .editor-header .icon-button {
                    background: none;
                    border: none;
                    color: #fff;
                    font-size: 18px;
                    cursor: pointer;
                    padding: 5px;
                    border-radius: 5px;
                    transition: background-color 0.2s ease, transform 0.1s ease;
                }
                
                .editor-header .icon-button:hover {
                    background-color: #333;
                }
                
                .editor-header .icon-button:active {
                    transform: scale(0.95);
                }

                .editor-content {
                    flex-grow: 1;
                    position: relative;
                    overflow: hidden;
                    display: flex;
                    flex-direction: row;
                }

                .number-bar {
                    width: 50px;
                    background-color: #000000;
                    padding: 20px 0;
                    color: #E0E0E0;
                    font-weight: bold;
                    text-align: right;
                    font-size: 16px;
                    line-height: 1.6;
                    box-sizing: border-box;
                    overflow-y: hidden;
                    white-space: pre-wrap;
                    flex-shrink: 0;
                    font-family: 'JetBrains Mono', monospace;
                }

                .number-bar div {
                    padding-right: 10px;
                    line-height: 1.6;
                    font-family: 'Poppins', sans-serif;
                    position: relative;
                }

                .number-bar div.active-line {
                    background-color: #007acc;
                    color: #E0E0E0;
                }
                
                .code-textarea {
                    width: 100%;
                    height: 100%;
                    padding: 20px;
                    background-color: #000000;
                    border: none;
                    outline: none;
                    color: #E0E0E0;
                    font-family: 'JetBrains Mono', monospace;
                    font-size: 16px;
                    line-height: 1.6;
                    resize: none;
                    box-sizing: border-box;
                    overflow-x: auto;
                    white-space: pre;
                    flex-grow: 1;
                }
                
                .close-btn {
                    background: none;
                    border: none;
                    color: #fff;
                    font-size: 32px;
                    cursor: pointer;
                    line-height: 1;
                }

                @media (max-width: 768px) {
                    header {
                        padding: 15px 20px;
                    }
                }

                /* --- Modal Styles --- */
                .modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.7);
                    display: none;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                }

                .modal-box {
                    background-color: #1e1e1e;
                    color: #E0E0E0;
                    padding: 30px;
                    border-radius: 12px;
                    text-align: center;
                    max-width: 350px;
                    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
                    animation: bounce 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
                }
                
                .modal-box.bounce-out {
                    animation: bounce-out 0.4s ease-in;
                }

                .modal-box h3 {
                    margin: 0 0 15px 0;
                    font-size: 24px;
                    font-weight: bold;
                }

                .modal-box p {
                    margin: 0 0 30px 0;
                    font-size: 16px;
                    line-height: 1.5;
                }

                .modal-buttons {
                    display: flex;
                    justify-content: center;
                    gap: 15px;
                }

                .modal-button {
                    padding: 10px 25px;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: bold;
                    transition: transform 0.1s ease, background-color 0.2s ease;
                }

                #download-modal-btn {
                    background-color: white;
                    color: black;
                }
                
                #close-modal-btn {
                    background-color: #FF3B30;
                    color: white;
                }

                .modal-button:active {
                    transform: scale(0.95);
                }

                /* --- Animations --- */
                @keyframes bounce {
                    0% { transform: scale(0.5); opacity: 0; }
                    50% { transform: scale(1.1); opacity: 1; }
                    100% { transform: scale(1); }
                }

                @keyframes bounce-out {
                    0% { transform: scale(1); opacity: 1; }
                    100% { transform: scale(0.5); opacity: 0; }
                }
            `;

            function renderCodeEditor(targetElementId) {
                // Inject CSS and HTML for the editor
                injectStyles(editorCssContent);
                document.getElementById(targetElementId).innerHTML = editorHtmlContent;
            }
            
            // Object to keep track of loaded plugins
            const loadedPlugins = {};
            
            // Function to load plugins dynamically
            const loadPluginForFile = async (fileName) => {
                const ext = fileName.slice(fileName.lastIndexOf('.') + 1);
                const pluginsMap = {
                    css: plugin_css,
                    html: plugin_html,
                    js: plugin_js,
                    json: plugin_json,
                    jsx: plugin_jsx,
                    md: plugin_md,
                    scss: plugin_scss,
                    svg: plugin_svg,
                    ts: plugin_ts,
                    xml: plugin_xml,
                    yaml: plugin_yaml
                };
                if (loadedPlugins[ext]) {
                    console.log(`Plugin for .${ext} already loaded.`);
                    return;
                }
                const plugin = pluginsMap[ext];
                if (plugin) {
                    console.log(`Plugin for .${ext} loaded successfully!`);
                    loadedPlugins[ext] = plugin;
                } else {
                    console.error(`Failed to load plugin for file type .${ext}.`);
                }
            };

            function initEditorListeners(initialFileName) {
                // Now that the elements exist, get references
                const editorCloseBtn = document.querySelector('.editor-close-btn');
                const mainContentArea = document.getElementById('main-content-area');
                const editorContainer = document.getElementById('code-editor-container');
                const codeTextarea = document.getElementById('code-textarea');
                const currentFileName = document.getElementById('current-file-name');
                const numberBar = document.querySelector('.number-bar');
                const selectAllButton = document.getElementById('select-all-button');
                const copyButton = document.getElementById('copy-button');
                const downloadButton = document.getElementById('download-button');
                const pasteButton = document.getElementById('paste-button');
                const modalOverlay = document.getElementById('modal-overlay');
                const modalBox = document.getElementById('modal-box');
                const closeModalBtn = document.getElementById('close-modal-btn');
                const downloadModalBtn = document.getElementById('download-modal-btn');

                // All the original functions and event listeners
                const updateLineNumbers = () => {
                    const lineCount = codeTextarea.value.split('\n').length;
                    let html = '';
                    for (let i = 1; i <= lineCount; i++) {
                        html += `<div>${i}</div>`;
                    }
                    numberBar.innerHTML = html;
                    highlightActiveLine();
                };

                const highlightActiveLine = () => {
                    const cursorPosition = codeTextarea.selectionStart;
                    const textBeforeCursor = codeTextarea.value.substring(0, cursorPosition);
                    const currentLine = textBeforeCursor.split('\n').length;
                    const lines = numberBar.querySelectorAll('div');
                    lines.forEach((line) => line.classList.remove('active-line'));
                    if (lines[currentLine - 1]) {
                        lines[currentLine - 1].classList.add('active-line');
                    }
                };

                const saveFileToDb = () => {
                    if (!appState.db) {
                        console.error('IndexedDB not initialized.');
                        return;
                    }
                    const transaction = appState.db.transaction(['files'], 'readwrite');
                    const objectStore = transaction.objectStore('files');
                    const fileToSave = {
                        name: currentFileName.textContent,
                        content: codeTextarea.value,
                        createdDate: new Date().getTime(),
                        size: new Blob([codeTextarea.value]).size
                    };
                    objectStore.put(fileToSave);
                    transaction.oncomplete = () => {
                        console.log('File saved successfully.');
                    };
                    transaction.onerror = (e) => {
                        console.error('Save failed:', e.target.error);
                    };
                };
                
                // Load or create a file in IndexedDB
                const loadOrFetchFile = (fileName) => {
                    if (!appState.db) {
                        console.error('IndexedDB not initialized.');
                        return;
                    }
                    const transaction = appState.db.transaction(['files'], 'readonly');
                    const objectStore = transaction.objectStore('files');
                    const request = objectStore.get(fileName);

                    request.onsuccess = (e) => {
                        const file = e.target.result;
                        if (file) {
                            appState.currentFile = file;
                            codeTextarea.value = file.content;
                            currentFileName.textContent = file.name;
                        } else {
                            appState.currentFile = { name: fileName, content: '' };
                            codeTextarea.value = '';
                            currentFileName.textContent = fileName;
                            saveFileToDb();
                        }
                        updateLineNumbers();
                        loadPluginForFile(fileName);
                        console.log(`File loaded: ${fileName}`);
                    };
                    request.onerror = (e) => {
                        console.error('Failed to get file:', e.target.error);
                        appState.currentFile = { name: fileName, content: '' };
                        codeTextarea.value = '';
                        currentFileName.textContent = fileName;
                        updateLineNumbers();
                        loadPluginForFile(fileName);
                    };
                };

                // Event Listeners
                codeTextarea.addEventListener('input', updateLineNumbers);
                codeTextarea.addEventListener('scroll', () => { numberBar.scrollTop = codeTextarea.scrollTop; });
                codeTextarea.addEventListener('keyup', highlightActiveLine);
                codeTextarea.addEventListener('click', highlightActiveLine);
                codeTextarea.addEventListener('input', saveFileToDb);

                selectAllButton.addEventListener('click', () => { codeTextarea.select(); });
                copyButton.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(codeTextarea.value);
                        alert('Content copied to clipboard!');
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                        alert('Failed to copy.');
                    }
                });
                downloadButton.addEventListener('click', () => {
                    const content = codeTextarea.value;
                    const fileName = currentFileName.textContent;
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
                pasteButton.addEventListener('click', async () => {
                    try {
                        const text = await navigator.clipboard.readText();
                        const start = codeTextarea.selectionStart;
                        const end = codeTextarea.selectionEnd;
                        codeTextarea.value = codeTextarea.value.substring(0, start) + text + codeTextarea.value.substring(end);
                        codeTextarea.selectionStart = codeTextarea.selectionEnd = start + text.length;
                        codeTextarea.dispatchEvent(new Event('input', { bubbles: true }));
                    } catch (err) {
                        console.error('Failed to read clipboard contents: ', err);
                        alert('Failed to paste content.');
                    }
                });

                const handleCloseModal = () => {
                    modalBox.classList.add('bounce-out');
                    setTimeout(() => {
                        modalOverlay.style.display = 'none';
                        modalBox.classList.remove('bounce-out');
                        
                        // Revert the slide effect
                        mainContentArea.classList.remove('slide-out');
                        editorContainer.classList.remove('slide-in');
                    }, 400);
                };

                editorCloseBtn.addEventListener('click', () => {
                    modalOverlay.style.display = 'flex';
                    modalBox.classList.remove('bounce-out');
                });
                closeModalBtn.addEventListener('click', handleCloseModal);
                downloadModalBtn.addEventListener('click', () => {
                    downloadButton.click();
                    handleCloseModal();
                });

                // Initial load of the specified file
                if (initialFileName) {
                    loadOrFetchFile(initialFileName);
                } else {
                    loadOrFetchFile('index.html');
                }
            }
            
            function initDbAndListeners(initialFileName) {
                const request = indexedDB.open('code_editor_db', 1);
                request.onupgradeneeded = (e) => {
                    appState.db = e.target.result;
                    if (!appState.db.objectStoreNames.contains('files')) {
                        appState.db.createObjectStore('files', { keyPath: 'name' });
                    }
                };
                request.onsuccess = (e) => {
                    appState.db = e.target.result;
                    initEditorListeners(initialFileName);
                };
                request.onerror = (e) => {
                    console.error('IndexedDB error:', e.target.errorCode);
                    alert("Error: Unable to use local storage. Please ensure you are running this from a web server.");
                };
            }

            // --- Main App Initialization ---
            setTimeout(() => {
                injectStyles(pageStyles);
                const mainContent = document.getElementById('main-content-area');
                mainContent.classList.add('visible');

                const newFileModal = document.getElementById('new-file-modal');
                const modalTitle = newFileModal.querySelector('.modal-title');
                const fileNameInput = document.getElementById('file-name-input');
                const confirmButton = document.getElementById('confirm-button');
                const cancelButton = document.getElementById('cancel-button');
                const fileUploadInput = document.getElementById('file-upload');
                const wrapper = document.getElementById('action-button-wrapper');

                let currentAction = null;

                function createTransformingButton(options) {
                    const container = document.createElement('div');
                    container.className = 'transform-button-container';
                    const buttonLabel = document.createElement('span');
                    buttonLabel.className = 'button-label';
                    buttonLabel.textContent = 'Tap to Open';
                    const menu = document.createElement('ul');
                    menu.className = 'transform-dropdown-menu';

                    options.forEach(optionText => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = '#';
                        a.textContent = optionText;
                        
                        if (optionText === 'New File') {
                            a.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                showModal('Create New File..', 'newFile', true);
                                container.classList.remove('active');
                            });
                        } else if (optionText === 'Open File') {
                            a.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                fileUploadInput.setAttribute('accept', '.js,.css,.html');
                                fileUploadInput.click();
                                container.classList.remove('active');
                            });
                        } else if (optionText === 'Open Zip') {
                            a.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                fileUploadInput.setAttribute('accept', '.zip');
                                fileUploadInput.click();
                                container.classList.remove('active');
                            });
                        } else if (optionText === 'New Repository') {
                            a.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                showModal('Create New Repository..', 'newRepo', false);
                                container.classList.remove('active');
                            });
                        } else {
                            a.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                alert(`Selected: ${optionText}`);
                                container.classList.remove('active');
                            });
                        }
                        li.appendChild(a);
                        menu.appendChild(li);
                    });
                    container.appendChild(buttonLabel);
                    container.appendChild(menu);
                    container.addEventListener('click', (e) => {
                        e.stopPropagation();
                        container.classList.toggle('active');
                    });
                    document.addEventListener('click', (e) => {
                        if (container.classList.contains('active') && !container.contains(e.target)) {
                            container.classList.remove('active');
                        }
                    });
                    return container;
                }

                function showModal(title, action, requiresExtension) {
                    modalTitle.textContent = title;
                    currentAction = action;
                    fileNameInput.removeEventListener('input', handleInputValidation);
                    function handleInputValidation() {
                        const value = fileNameInput.value.trim();
                        confirmButton.disabled = requiresExtension ? !value.includes('.') : value.length === 0;
                    }
                    fileNameInput.addEventListener('input', handleInputValidation);
                    newFileModal.classList.add('visible');
                    fileNameInput.value = '';
                    confirmButton.disabled = true;
                    fileNameInput.focus();
                }

                function hideModal() {
                    newFileModal.classList.remove('visible');
                    fileNameInput.value = '';
                    confirmButton.disabled = true;
                    currentAction = null;
                }

                async function openEditor(fileName) {
                    const mainContentArea = document.getElementById('main-content-area');
                    const editorContainer = document.getElementById('code-editor-container');
                    
                    // Render the editor's HTML/CSS immediately.
                    renderCodeEditor('code-editor-container');

                    // Start the sliding animation.
                    mainContentArea.classList.add('slide-out');
                    editorContainer.classList.add('slide-in');

                    // Initialize the database and editor listeners with the filename.
                    initDbAndListeners(fileName);
                }

                confirmButton.addEventListener('click', () => {
                    const value = fileNameInput.value.trim();
                    if (value.length > 0) {
                        hideModal();
                        if (currentAction === 'newFile') {
                            openEditor(value);
                        } else if (currentAction === 'newRepo') {
                            repoManager.openRepo(value);
                        }
                    } else {
                        alert('Please enter a valid name.');
                    }
                });
                cancelButton.addEventListener('click', hideModal);
                
                fileUploadInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const isZip = file.name.toLowerCase().endsWith('.zip');
                        if (isZip) {
                            repoManager.unpackAndOpenRepo(file.name);
                        } else {
                            // Note: You would need a way to read the file content here for a full implementation.
                            // For now, this will simply open the editor with the correct filename.
                            openEditor(file.name);
                        }
                        e.target.value = '';
                    }
                });

                const options = ['New File', 'Open File', 'Open Zip', 'New Repository'];
                const myTransformingButton = createTransformingButton(options);
                wrapper.appendChild(myTransformingButton);
            }, 3000);
        });
    </script>
</body>
</html>
